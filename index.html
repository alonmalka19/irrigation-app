<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Irrigation System</title>
    <meta name="theme-color" content="#1F8A4D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--ink);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* CSS Variables */
        :root {
            --bg: #F5F7F4;
            --surface: #FFFFFF;
            --ink: #0E1A13;
            --muted: #6C7A70;
            --accent: #1F8A4D;
            --accent-light: #DDEEE4;
            --ok: #1BAA66;
            --danger: #D64A4A;
            --radius: 20px;
            --shadow: 0 10px 30px rgba(15,35,25,.08);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Header */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: var(--surface);
            border-radius: 0 0 var(--radius) var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 32px;
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 400;
            color: var(--ink);
        }

        .brand b {
            color: var(--accent);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #fff;
            padding: 0.35rem 0.7rem;
            border-radius: 999px;
            box-shadow: var(--shadow);
            font-size: 0.9rem;
            color: var(--muted);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--ok);
        }

        /* Hero */
        .hero {
            position: relative;
            min-height: 56vh;
            display: flex;
            align-items: flex-end;
            border-radius: calc(var(--radius) + 6px);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 36px;
        }

        .hero::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,.45) 0%, rgba(0,0,0,.25) 40%, rgba(0,0,0,0) 65%),
                        url('https://images.unsplash.com/photo-1558904541-efa843a96f01?w=1600&q=80') center/cover no-repeat;
            filter: saturate(1.05) contrast(1.02);
        }

        .hero-inner {
            position: relative;
            z-index: 1;
            color: #fff;
            padding: clamp(28px, 4vw, 48px);
            width: 100%;
        }

        .hero h1 {
            margin: 0 0 0.4rem;
            font-weight: 800;
            line-height: 1.08;
            font-size: clamp(2.2rem, 4.6vw, 4rem);
            letter-spacing: 0.3px;
        }

        .hero p {
            margin: 0.2rem 0 0;
            color: rgba(255,255,255,.92);
            font-size: clamp(1rem, 1.8vw, 1.25rem);
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            color: var(--muted);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        /* Control Section */
        .valve-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px;
            background: var(--accent-light);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .valve-info h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
        }

        .status-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .badge {
            background: var(--surface);
            color: var(--accent);
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .toggle {
            width: 58px;
            height: 34px;
            border-radius: 999px;
            background: #E7ECE9;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 0 0 2px rgba(0,0,0,.04);
            transition: background 0.3s;
        }

        .toggle::after {
            content: "";
            position: absolute;
            top: 3px;
            right: 3px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .toggle.on {
            background: rgba(27,170,102,.25);
        }

        .toggle.on::after {
            transform: translateX(-24px);
        }

        .valve-status {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 8px;
        }

        /* Buttons */
        .btn {
            appearance: none;
            border: 0;
            border-radius: 14px;
            padding: 14px 16px;
            background: #ECF2EF;
            color: var(--ink);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
            font-size: 0.95rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(15,35,25,.12);
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Quick Actions */
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        /* Schedule */
        .schedule-list {
            display: grid;
            gap: 12px;
        }

        .schedule-item {
            display: grid;
            grid-template-columns: 90px 1fr 120px auto;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 14px;
            background: var(--accent-light);
        }

        .pill {
            background: var(--surface);
            color: var(--accent);
            border-radius: 999px;
            padding: 0.3rem 0.7rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
        }

        .iconbtn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--surface);
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 0;
        }

        .iconbtn:hover {
            transform: translateY(-2px);
        }

        /* Weather Section */
        .weather-card {
            background: linear-gradient(135deg, rgba(255,167,38,.95), rgba(251,140,0,.95)),
                        url('https://images.unsplash.com/photo-1601297183305-6df142704ea2?w=800&q=80') center/cover;
            border-radius: var(--radius);
            padding: 32px;
            color: white;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .weather-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 12px;
        }

        .weather-info h3 {
            margin: 12px 0 8px;
            font-size: 1.2rem;
        }

        .weather-info p {
            margin: 0;
            opacity: 0.9;
        }

        /* Activity List */
        .activity-list {
            display: grid;
            gap: 8px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--accent-light);
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .activity-time {
            color: var(--muted);
            font-size: 0.8rem;
        }

        /* Garden Section */
        .garden-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            align-items: center;
        }

        .garden-image {
            border-radius: 16px;
            overflow: hidden;
            height: 280px;
        }

        .garden-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .garden-text h2 {
            font-size: 1.8rem;
            margin-bottom: 16px;
            font-weight: 800;
        }

        .garden-text p {
            color: var(--muted);
            line-height: 1.6;
        }

        /* Chat Bot Styles */
        .chat-bubble {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent) 0%, #0F5132 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(31,138,77,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .chat-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(31,138,77,0.4);
        }

        .chat-bubble-icon {
            font-size: 28px;
            animation: pulse 2s infinite;
        }

        .chat-bubble-pulse {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .chat-window {
            position: fixed;
            bottom: 100px;
            left: 24px;
            width: 380px;
            height: 520px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-window.active {
            display: flex;
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--accent) 0%, #0F5132 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .chat-title h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chat-title p {
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-welcome {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .welcome-avatar {
            width: 40px;
            height: 40px;
            background: var(--accent-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .welcome-text h4 {
            margin: 0 0 8px 0;
            font-size: 1rem;
            color: var(--ink);
        }

        .welcome-text p {
            margin: 0 0 12px 0;
            color: var(--muted);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .welcome-examples {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .example {
            background: var(--accent-light);
            color: var(--accent);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-style: italic;
        }

        .chat-message {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background: var(--accent);
            color: white;
        }

        .message-avatar.bot {
            background: var(--accent-light);
            color: var(--accent);
        }

        .message-content {
            max-width: 250px;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-message.user .message-content {
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.bot .message-content {
            background: #f5f5f5;
            color: var(--ink);
            border-bottom-left-radius: 4px;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .chat-typing {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
            color: var(--muted);
            font-size: 0.85rem;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 24px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--accent);
        }

        .chat-send {
            width: 44px;
            height: 44px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send:disabled {
            background: #ddd;
            cursor: not-allowed;
        }

        .chat-send:not(:disabled):hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(31,138,77,0.3);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 32px 0;
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 48px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .day-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .day-selector button {
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .day-selector button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .time-input, .duration-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: var(--ink);
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-save {
            background: var(--accent);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .garden-section {
                grid-template-columns: 1fr;
            }

            .garden-image {
                height: 300px;
            }
        }

        @media (max-width: 640px) {
            .schedule-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .btn-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .hero {
                min-height: 48vh;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="container topbar">
        <div class="brand"><b>Premium</b> מערכת השקייה</div>
        <div class="chip">
            <span class="dot"></span>
            <span id="currentTime">00:00:00</span>
        </div>
    </header>

    <main class="container">
        <!-- Hero -->
        <section class="hero">
            <div class="hero-inner">
                <h1>השקיה חכמה – פשוטה ואלגנטית</h1>
                <p>שליטה קלה ומיידית, לוח זמנים חכם והמלצות מותאמות למזג-האוויר</p>
            </div>
        </section>

        <!-- Main Grid -->
        <div class="grid-2">
            <!-- Left Column -->
            <div>
                <!-- Control Center -->
                <div class="card">
                    <h2 class="card-title">מרכז שליטה</h2>
                    <p class="card-subtitle">ניהול הברז הראשי וסטטוסי מערכת</p>

                    <div class="valve-control">
                        <div class="valve-info">
                            <h3>ברז ראשי</h3>
                            <div class="valve-status" id="valveStatus">הברז סגור</div>
                            <div class="status-badges">
                                <span class="badge">📶 -62 dBm</span>
                                <span class="badge">💾 120KB</span>
                                <span class="badge" id="systemTime">🕐 --:--</span>
                            </div>
                        </div>
                        <div>
                            <div class="toggle" id="valveToggle" onclick="toggleValve()"></div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h2 class="card-title">פעולות מהירות</h2>
                    <p class="card-subtitle">בחר משך להפעלה מיידית</p>

                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="quickRun(30, 'שניות')">פתח 30ש׳</button>
                        <button class="btn" onclick="quickRun(1, 'דקות')">1 דקה</button>
                        <button class="btn" onclick="quickRun(5, 'דקות')">5 דק׳</button>
                        <button class="btn" onclick="quickRun(10, 'דקות')">10 דק׳</button>
                        <button class="btn" onclick="quickRun(30, 'דקות')">30 דק׳</button>
                    </div>
                    <button class="btn btn-danger" style="width: 100%;" onclick="emergencyStop()">⏸ עצירת חירום</button>
                </div>

                <!-- Weather -->
                <div class="card" style="grid-column: span 2;">
                    <h2 class="card-title">תחזית מזג אוויר שבועית</h2>
                    <div id="weeklyForecast" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px;">
                        <!-- Weekly forecast will be inserted here -->
                    </div>
                    <div id="aiRecommendation" style="margin-top: 16px; padding: 12px; background: var(--accent); border-radius: 8px; font-size: 14px;">
                        טוען המלצות...
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- Schedule -->
                <div class="card">
                    <h2 class="card-title">לוח זמנים מתקדם</h2>
                    <p class="card-subtitle">ניהול גמיש של השקיות השבוע</p>

                    <div class="schedule-list" id="scheduleTable">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                    <div style="margin-top: 16px; display: flex; justify-content: flex-end;">
                        <button class="btn btn-primary" id="addScheduleBtn">הוסף השקיה מתוזמנת</button>
                    </div>
                </div>

                <!-- Activity -->
                <div class="card">
                    <h2 class="card-title">פעילות מערכת אחרונה</h2>
                    <div class="activity-list" id="activityList">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Garden Section -->
        <section class="card">
            <div class="garden-section">
                <div class="garden-image">
                    <img src="https://images.unsplash.com/photo-1585320806297-9794b3e4eeae?w=800&q=80" alt="Beautiful garden">
                </div>
                <div class="garden-text">
                    <h2>מזג-אוויר והמלצות AI בקצות האצבעות</h2>
                    <p id="aiRecommendation">הישאר מעודכן בתחזית המזג אוויר וקבל המלצות השקיה חכמות המותאמות לגינה שלך לטיפול אופטימלי.</p>
                </div>
            </div>
        </section>

        <footer>
            © Premium מערכת השקייה – ממשק בעיצוב גינה חי, מהיר ויעיל ל-ESP32
        </footer>
  </main>

  <!-- AI Chat Bot -->
  <div class="chat-bubble" id="chatBubble" title="דבר עם הבוט החכם">
    <div class="chat-bubble-icon">🤖</div>
    <div class="chat-bubble-pulse"></div>
  </div>

  <div class="chat-window" id="chatWindow">
    <div class="chat-header">
      <div class="chat-header-content">
        <div class="chat-avatar">🤖</div>
        <div class="chat-title">
          <h3>בוט השקיה חכם</h3>
          <p>כאן כדי לעזור לך עם השקיות</p>
        </div>
      </div>
      <button class="chat-close" id="chatClose" aria-label="סגור צ'אט">✕</button>
    </div>

    <div class="chat-body" id="chatBody">
      <div class="chat-welcome">
        <div class="welcome-avatar">🌱</div>
        <div class="welcome-text">
          <h4>שלום! אני הבוט החכם שלך</h4>
          <p>אני יכול לעזור לך להוסיף השקיות ללוח הזמנים. פשוט אמור לי מתי תרצה להשקות!</p>
          <div class="welcome-examples">
            <span class="example">"השק לי מחר ב-7 בבוקר"</span>
            <span class="example">"אני רוצה השקיה כל יום שני"</span>
            <span class="example">"תוסיף השקיה לחמישי ב-18:30"</span>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-typing" id="chatTyping" style="display: none;">
        <span>הבוט כותב</span>
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      <div class="chat-input-wrapper">
        <input type="text" class="chat-input" id="chatInput" placeholder="כתוב את בקשת ההשקיה שלך..." maxlength="500">
        <button class="chat-send" id="chatSend" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M2 21L23 12 2 3V10L17 12 2 14V21Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Premium Schedule Modal -->
  <div class="modal" id="scheduleModal" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">הוסף השקה מתוזמנת</h3>
        <button class="modal-close" id="modalClose" aria-label="סגור חלון">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="daySelector">בחר יום בשבוע</label>
          <div class="day-selector" id="daySelector" role="group" aria-label="בחירת יום">
            <button type="button" data-day="0" title="יום ראשון">א</button>
            <button type="button" data-day="1" title="יום שני">ב</button>
            <button type="button" data-day="2" title="יום שלישי">ג</button>
            <button type="button" data-day="3" title="יום רביעי">ד</button>
            <button type="button" data-day="4" title="יום חמישי">ה</button>
            <button type="button" data-day="5" title="יום שישי">ו</button>
            <button type="button" data-day="6" title="שבת">ש</button>
          </div>
        </div>
        <div class="form-group">
          <label for="scheduleTime">שעת התחלת ההשקיה</label>
          <input type="time" id="scheduleTime" class="time-input" required aria-describedby="timeHelp">
        </div>
        <div class="form-group">
          <label for="scheduleDuration">משך השקיה (דקות)</label>
          <input type="number" id="scheduleDuration" min="1" max="120" value="10" class="duration-input" required aria-describedby="durationInfo">
          <div class="duration-info" id="durationInfo">סה"כ כולל פתיחה וסגירה: <span id="totalDuration">11:00</span></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-cancel" id="modalCancel">ביטול</button>
        <button type="submit" class="btn-save" id="modalSave">שמור השקה</button>
      </div>
    </div>
  </div>

  <!-- All JavaScript moved to app.js -->
  <script src="/app.js"></script>
<script>
window.FORCE_REMOTE_MODE = true;
</script>
<script>
const APP_VERSION='3.7';

// Constants
const DAYS = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"];
const VALVE_TRANSITION_TIME = 30; // seconds
const PROGRESS_CIRCLE_CIRCUMFERENCE = 377;

// Elements
const elements = {
  currentTime: document.getElementById('currentTime'),
  valveToggle: document.getElementById('valveToggle'),
  valveStatus: document.getElementById('valveStatus'),
  systemTime: document.getElementById('systemTime'),
  scheduleTable: document.getElementById('scheduleTable'),
  addScheduleBtn: document.getElementById('addScheduleBtn'),
  scheduleModal: document.getElementById('scheduleModal'),
  modalClose: document.getElementById('modalClose'),
  modalCancel: document.getElementById('modalCancel'),
  modalSave: document.getElementById('modalSave'),
  daySelector: document.getElementById('daySelector'),
  scheduleTime: document.getElementById('scheduleTime'),
  scheduleDuration: document.getElementById('scheduleDuration'),
  totalDuration: document.getElementById('totalDuration'),
  activityList: document.getElementById('activityList'),
  chatBubble: document.getElementById('chatBubble'),
  chatWindow: document.getElementById('chatWindow'),
  chatClose: document.getElementById('chatClose'),
  chatBody: document.getElementById('chatBody'),
  chatInput: document.getElementById('chatInput'),
  chatSend: document.getElementById('chatSend'),
  chatTyping: document.getElementById('chatTyping')
};

// App State
let appState = {
  valveState: 'closed', // closed, opening, open, closing
  remainingSeconds: 0,
  timerInterval: null,
  progressInterval: null,
  isManualOperation: false,
  scheduleData: { week: [[], [], [], [], [], [], []] },
  lastActivity: [],
  mqttEnabled: false,
  mqttClient: null,
  localMode: true // true when connected via local IP
};

// API Helper
async function api(path, options = {}) {
  try {
    const response = await fetch(path, {
      headers: { 'Content-Type': 'application/json' },
      ...options
    });
    if (!response.ok) throw new Error(await response.text());
    return await response.json();
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
}

// Time formatting
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatDateTime(date) {
  return new Intl.DateTimeFormat('he-IL', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    day: '2-digit',
    month: '2-digit'
  }).format(date);
}

// Progress ring animation
function updateProgressRing(percentage) {
  const offset = PROGRESS_CIRCLE_CIRCUMFERENCE - (percentage / 100) * PROGRESS_CIRCLE_CIRCUMFERENCE;
  elements.progressCircle.style.strokeDashoffset = offset;
}

// Valve State Management
function updateValveDisplay() {
  const { valveState, remainingSeconds } = appState;

  // Update toggle state
  if (elements.valveToggle) {
    if (valveState === 'open' || valveState === 'opening') {
      elements.valveToggle.classList.add('on');
    } else {
      elements.valveToggle.classList.remove('on');
    }
  }

  // Update status text
  if (elements.valveStatus) {
    const statusTexts = {
      closed: 'הברז סגור',
      opening: `פותח... ${remainingSeconds}s`,
      open: 'הברז פתוח',
      closing: `סוגר... ${remainingSeconds}s`
    };
    elements.valveStatus.textContent = statusTexts[valveState];
  }

  // Update system time display
  if (elements.systemTime) {
    const now = new Date();
    const timeStr = `🕐 ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    elements.systemTime.textContent = timeStr;
  }
}

// Timer Management
function startTransitionTimer(duration, onComplete) {
  clearInterval(appState.timerInterval);
  appState.remainingSeconds = duration;

  appState.timerInterval = setInterval(() => {
    appState.remainingSeconds--;
    updateValveDisplay();

    if (appState.remainingSeconds <= 0) {
      clearInterval(appState.timerInterval);
      onComplete();
    }
  }, 1000);
}

// Valve Control Functions
async function openValve() {
  if (appState.valveState !== 'closed') return;

  appState.valveState = 'opening';
  appState.isManualOperation = true;
  updateValveDisplay();
  addActivity('🔄', 'מתחיל פתיחת ברז');

  try {
    await sendValveCommand('open');
    startTransitionTimer(VALVE_TRANSITION_TIME, () => {
      appState.valveState = 'open';
      updateValveDisplay();
      addActivity('💧', 'ברז נפתח בהצלחה');
    });
  } catch (error) {
    appState.valveState = 'closed';
    updateValveDisplay();
    addActivity('❌', 'שגיאה בפתיחת ברז');
  }
}

async function closeValve() {
  if (appState.valveState !== 'open') return;

  appState.valveState = 'closing';
  updateValveDisplay();
  addActivity('🔄', 'מתחיל סגירת ברז');

  try {
    await sendValveCommand('close');
    startTransitionTimer(VALVE_TRANSITION_TIME, () => {
      appState.valveState = 'closed';
      appState.isManualOperation = false;
      updateValveDisplay();
      addActivity('🚿', 'ברז נסגר בהצלחה');
    });
  } catch (error) {
    appState.valveState = 'open';
    updateValveDisplay();
    addActivity('❌', 'שגיאה בסגירת ברז');
  }
}

async function openValveImmediate() {
  if (appState.valveState !== 'closed') return;

  appState.valveState = 'opening';
  updateValveDisplay();
  addActivity('🚀', 'פתיחה מיידית של הברז');

  try {
    await api('/api/zone?cmd=open', { method: 'POST' });
    startTransitionTimer(VALVE_TRANSITION_TIME, () => {
      appState.valveState = 'open';
      appState.isManualOperation = true;
      updateValveDisplay();
      addActivity('💧', 'ברז נפתח מיידית - מוכן לשימוש');
    });
  } catch (error) {
    appState.valveState = 'closed';
    updateValveDisplay();
    addActivity('❌', 'שגיאה בפתיחה מיידית');
  }
}

async function closeValveImmediate() {
  if (appState.valveState === 'closed' || appState.valveState === 'closing') return;

  appState.valveState = 'closing';
  updateValveDisplay();
  addActivity('🚀', 'סגירה מיידית של הברז');

  try {
    await api('/api/zone?cmd=close', { method: 'POST' });
    startTransitionTimer(VALVE_TRANSITION_TIME, () => {
      appState.valveState = 'closed';
      appState.isManualOperation = false;
      updateValveDisplay();
      addActivity('🚿', 'ברז נסגר מיידית');
    });
  } catch (error) {
    appState.valveState = 'open';
    updateValveDisplay();
    addActivity('❌', 'שגיאה בסגירה מיידית');
  }
}

async function quickIrrigation(durationMinutes) {
  if (appState.valveState !== 'closed') return;

  const totalSeconds = (durationMinutes * 60) + (VALVE_TRANSITION_TIME * 2);
  addActivity('⚡', `השקה מהירה: ${durationMinutes} דקות (${formatTime(totalSeconds)} כולל)`);

  // Open valve
  appState.valveState = 'opening';
  appState.isManualOperation = true;
  updateValveDisplay();

  try {
    await api('/api/zone?cmd=open', { method: 'POST' });
    startTransitionTimer(VALVE_TRANSITION_TIME, () => {
      appState.valveState = 'open';
      updateValveDisplay();

      // Start irrigation timer
      const irrigationSeconds = durationMinutes * 60;
      appState.remainingSeconds = irrigationSeconds;
      elements.statusTimer.textContent = formatTime(irrigationSeconds);

      appState.timerInterval = setInterval(() => {
        appState.remainingSeconds--;
        elements.statusTimer.textContent = formatTime(appState.remainingSeconds);

        if (appState.remainingSeconds <= 0) {
          clearInterval(appState.timerInterval);
          closeValve();
        }
      }, 1000);
    });
  } catch (error) {
    appState.valveState = 'closed';
    updateValveDisplay();
    addActivity('❌', 'שגיאה בהשקה מהירה');
  }
}

// New Design Functions
window.toggleValve = function() {
  if (appState.valveState === 'closed') {
    openValve();
  } else if (appState.valveState === 'open') {
    closeValve();
  }
};

window.quickRun = function(duration, unit) {
  const minutes = unit === 'שניות' ? Math.round(duration / 60 * 100) / 100 : duration;
  quickIrrigation(minutes);
};

window.emergencyStop = function() {
  clearInterval(appState.timerInterval);
  appState.valveState = 'closing';
  appState.isManualOperation = true;
  updateValveDisplay();

  api('/api/zone?cmd=close', { method: 'POST' })
    .then(() => {
      startTransitionTimer(VALVE_TRANSITION_TIME, () => {
        appState.valveState = 'closed';
        updateValveDisplay();
        addActivity('🛑', 'עצירת חירום בוצעה');
      });
    })
    .catch(() => {
      addActivity('❌', 'שגיאה בעצירת חירום');
    });
};

window.addSchedule = function() {
  openScheduleModal();
};

// ======= Hebrew AI Chatbot Engine =======

// Hebrew patterns for natural language processing
const hebrewPatterns = {
  // Core irrigation actions
  irrigate: /השק|השקה|השקיה|תשקה|תשק|רטב|תרטיב|תזליף|זליפה/,
  add: /תוסיף|הוסף|צריך|רוצה|אני רוצה|תקבע|קבע|בקש|מבקש/,

  // Time references
  tomorrow: /מחר|מחרתיים/,
  today: /היום|כעת|עכשיו/,

  // Days of the week
  sunday: /ראשון|יום א'?|יום ראשון/,
  monday: /שני|יום ב'?|יום שני/,
  tuesday: /שלישי|יום ג'?|יום שלישי/,
  wednesday: /רביעי|יום ד'?|יום רביעי/,
  thursday: /חמישי|יום ה'?|יום חמישי/,
  friday: /שישי|יום ו'?|יום שישי/,
  saturday: /שבת|יום ש'?|יום שבת/,

  // Time patterns with context
  hour: /(\d{1,2}):?(\d{0,2})?\s*(בבוקר|בערב|אחר הצהריים|בלילה|אחה"צ)?/,

  // Duration patterns
  duration: /(\d+)\s*(דקות?|דקה|שעות?|שעה)/
};

// Chat UI Management
function openChatWindow() {
  const chatWindow = elements.chatWindow;
  const chatBubble = elements.chatBubble;

  if (chatWindow && chatBubble) {
    chatWindow.style.display = 'flex';
    chatWindow.style.opacity = '1';
    chatWindow.style.transform = 'translateY(0) scale(1)';
    chatWindow.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    chatBubble.style.display = 'none';

    // Add welcome message if chat is empty
    if (elements.chatBody && elements.chatBody.children.length === 1) {
      const welcomeMsg = 'שלום! 👋 אני הבוט החכם להשקיה.\n\nאתה יכול לבקש ממני:\n• "השק לי מחר ב-7 בבוקר"\n• "תוסיף השקיה ליום שני"\n• "אני רוצה השקיה בערב"';
      addChatMessage(welcomeMsg, false);
    }

    // Initialize send button state and focus input
    setTimeout(() => {
      if (elements.chatInput) {
        elements.chatInput.focus();
        // Initialize send button as disabled
        if (elements.chatSend) {
          elements.chatSend.disabled = true;
          elements.chatSend.style.opacity = '0.5';
          elements.chatSend.style.cursor = 'not-allowed';
        }
      }
    }, 300);
  }
}

function closeChatWindow() {
  const chatWindow = elements.chatWindow;
  const chatBubble = elements.chatBubble;

  if (chatWindow && chatBubble) {
    chatWindow.style.opacity = '0';
    chatWindow.style.transform = 'translateY(100%) scale(0.8)';
    setTimeout(() => {
      chatWindow.style.display = 'none';
      chatBubble.style.display = 'flex';
    }, 300);
  }
}

function addChatMessage(message, isUser = false) {
  const chatBody = elements.chatBody;
  if (!chatBody) return;

  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'}`;
  messageDiv.innerHTML = `
    <div class="message-content">${message}</div>
    <div class="message-time">${new Date().toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'})}</div>
  `;

  chatBody.appendChild(messageDiv);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function showTypingIndicator() {
  const chatTyping = elements.chatTyping;
  if (chatTyping) {
    chatTyping.style.display = 'flex';
    elements.chatBody.scrollTop = elements.chatBody.scrollHeight;
  }
}

function hideTypingIndicator() {
  const chatTyping = elements.chatTyping;
  if (chatTyping) {
    chatTyping.style.display = 'none';
  }
}

// Hebrew Text Processing Functions
function extractDay(message) {
  // Tomorrow = today + 1
  if (hebrewPatterns.tomorrow.test(message)) {
    const today = new Date().getDay();
    return (today + 1) % 7;
  }

  // Specific days
  const dayMap = {
    sunday: 0, monday: 1, tuesday: 2, wednesday: 3,
    thursday: 4, friday: 5, saturday: 6
  };

  for (const [dayName, dayNum] of Object.entries(dayMap)) {
    if (hebrewPatterns[dayName].test(message)) {
      return dayNum;
    }
  }

  return null;
}

function extractTime(message) {
  const timeMatch = message.match(hebrewPatterns.hour);
  if (!timeMatch) return '07:00'; // Default morning time

  let hour = parseInt(timeMatch[1]);
  let minute = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
  const period = timeMatch[3];

  // Convert based on time period
  if (period) {
    if (period.includes('בערב') || period.includes('אחר הצהריים') || period.includes('אחה"צ')) {
      if (hour < 12) hour += 12;
    } else if (period.includes('בלילה')) {
      if (hour < 6) hour += 12;
    }
    // 'בבוקר' stays as is
  }

  // Ensure valid hour range
  if (hour > 23) hour = 23;
  if (minute > 59) minute = 59;

  return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
}

function extractDuration(message) {
  const durationMatch = message.match(hebrewPatterns.duration);
  if (!durationMatch) return 10; // Default 10 minutes

  const amount = parseInt(durationMatch[1]);
  const unit = durationMatch[2];

  if (unit.includes('שעה') || unit.includes('שעות')) {
    return amount * 60; // Convert hours to minutes
  }

  return amount; // Already in minutes
}

function getDayName(dayNumber) {
  const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
  return dayNames[dayNumber] || 'לא ידוע';
}

// Main Message Processing
async function processMessage(userInput) {
  const msg = userInput.toLowerCase().trim();

  // Check if it's an irrigation request
  if (!hebrewPatterns.irrigate.test(msg) && !hebrewPatterns.add.test(msg)) {
    return generateHelpMessage();
  }

  // Extract information
  const schedule = {
    day: extractDay(msg),
    time: extractTime(msg),
    duration: extractDuration(msg)
  };

  // Generate response
  if (schedule.day !== null) {
    return await createScheduleResponse(schedule);
  } else {
    return askForClarification();
  }
}

function generateHelpMessage() {
  const helpMessages = [
    'אני יכול לעזור לך לתזמן השקיה! נסה לכתוב משהו כמו:',
    '• "השק לי מחר ב-7 בבוקר"',
    '• "אני רוצה השקיה כל יום שני"',
    '• "תוסיף השקיה לחמישי ב-18:30"'
  ];
  return helpMessages.join('\n');
}

function askForClarification() {
  const clarificationMessages = [
    'לא הצלחתי להבין איזה יום אתה מתכוון. אפשר לנסות שוב?',
    'למשל: "השק לי מחר ב-8 בבוקר" או "תוסיף השקיה ליום שני"'
  ];
  return clarificationMessages.join('\n');
}

async function createScheduleResponse(schedule) {
  const dayName = getDayName(schedule.day);
  const responses = [
    `מעולה! השקיה נקבעה ליום ${dayName} ב-${schedule.time} למשך ${schedule.duration} דקות 🌱`,
    `בוצע! אטפל בהשקיה ביום ${dayName} ב-${schedule.time} ✨`,
    `הבנתי! השקיה ליום ${dayName} ב-${schedule.time} נוספה לרשימה 💧`
  ];

  // Add the schedule to the system
  try {
    await addScheduleFromBot(schedule);
  } catch (error) {
    console.error('Error adding schedule:', error);
  }

  return responses[Math.floor(Math.random() * responses.length)];
}

// Integration with Schedule System
async function addScheduleFromBot(scheduleData) {
  try {
    // Create schedule object
    const newSchedule = {
      start: scheduleData.time,
      duration: scheduleData.duration,
      frequency: 'once'
    };

    // Add to local schedule
    if (!appState.scheduleData.week[scheduleData.day]) {
      appState.scheduleData.week[scheduleData.day] = [];
    }

    appState.scheduleData.week[scheduleData.day].push(newSchedule);

    // Sort by time
    appState.scheduleData.week[scheduleData.day].sort((a, b) =>
      a.start.localeCompare(b.start)
    );

    // Save to server
    await saveScheduleToServer();

    // Refresh display
    loadScheduleDisplay();

  } catch (error) {
    console.error('Error adding schedule from bot:', error);
  }
}

// Chat Event Handlers
function handleChatSend() {
  const chatInput = elements.chatInput;
  if (!chatInput) return;

  const userMessage = chatInput.value.trim();
  if (!userMessage) return;

  // Add user message
  addChatMessage(userMessage, true);
  chatInput.value = '';

  // Reset send button to disabled state
  if (elements.chatSend) {
    elements.chatSend.disabled = true;
    elements.chatSend.style.opacity = '0.5';
    elements.chatSend.style.cursor = 'not-allowed';
  }

  // Show typing indicator
  showTypingIndicator();

  // Process message and respond
  setTimeout(async () => {
    hideTypingIndicator();
    const botResponse = await processMessage(userMessage);
    addChatMessage(botResponse, false);
  }, 1000 + Math.random() * 1000); // Random delay for realism
}

// Activity Log
function addActivity(icon, message) {
  const now = new Date();
  const activity = {
    icon,
    message,
    time: formatDateTime(now),
    timestamp: now.getTime()
  };

  appState.lastActivity.unshift(activity);
  if (appState.lastActivity.length > 20) {
    appState.lastActivity.pop();
  }

  renderActivityTimeline();
}

function renderActivityTimeline() {
  const activityList = document.getElementById('activityList');
  if (!activityList) return;

  // Show only last 3 activities
  const recentActivities = appState.lastActivity.slice(0, 3);

  activityList.innerHTML = recentActivities.map(activity => `
    <div class="activity-item">
      <span>${activity.message}</span>
      <span class="activity-time">${activity.time}</span>
    </div>
  `).join('') || '<div style="padding:1rem;text-align:center;color:var(--muted)">אין פעילות אחרונה</div>';
}

// Schedule Management
function renderScheduleTable() {
  const scheduleTable = document.getElementById('scheduleTable');
  if (!scheduleTable) return;

  const rows = [];
  appState.scheduleData.week.forEach((daySchedules, dayIndex) => {
    daySchedules.forEach((schedule, scheduleIndex) => {
      const duration = parseInt(schedule.duration || 10);
      const totalMinutes = duration + 1; // +1 for transitions
      rows.push(`
        <div class="schedule-item">
          <span class="pill">${DAYS[dayIndex]}</span>
          <div>${schedule.start} · ${duration} דק׳</div>
          <span class="pill">${daySchedules.length} פעולות</span>
          <div style="display: flex; gap: 8px;">
            <button class="iconbtn" onclick="editSchedule(${dayIndex}, ${scheduleIndex})">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z"></path>
              </svg>
            </button>
            <button class="iconbtn" onclick="deleteSchedule(${dayIndex}, ${scheduleIndex})">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M8 6V4h8v2M6 6l1 14h10l1-14"></path>
              </svg>
            </button>
          </div>
        </div>
      `);
    });
  });

  scheduleTable.innerHTML = rows.join('') || '<div style="padding:1rem;text-align:center;color:var(--muted)">אין השקיות מתוכננות</div>';
}

async function loadSchedule() {
  try {
    const data = await api('/api/schedule');
    appState.scheduleData = data;
    renderScheduleTable();
  } catch (error) {
    console.error('Failed to load schedule:', error);
  }
}

async function saveSchedule() {
  try {
    // If MQTT is enabled, publish schedule to MQTT
    if (appState.mqttEnabled && appState.mqttClient && appState.mqttClient.connected) {
      appState.mqttClient.publish(
        MQTT_CONFIG.topics.schedule,
        JSON.stringify(appState.scheduleData),
        { retain: true }
      );
      addActivity('💾', 'לוח זמנים נשמר וסונכרן');
    } else {
      // Fallback to HTTP API for local mode
      await api('/api/schedule', {
        method: 'POST',
        body: JSON.stringify(appState.scheduleData)
      });
      addActivity('💾', 'לוח זמנים נשמר בהצלחה');
    }
  } catch (error) {
    console.error('Save schedule error:', error);
    addActivity('❌', 'שגיאה בשמירת לוח זמנים');
  }
}

// Modal Management
function openScheduleModal() {
  elements.scheduleModal.classList.add('active');
  elements.scheduleDuration.value = 10;
  updateTotalDuration();
}

function closeScheduleModal() {
  elements.scheduleModal.classList.remove('active');
  elements.daySelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
  elements.scheduleTime.value = '';
  elements.scheduleDuration.value = 10;
}

function updateTotalDuration() {
  const duration = parseInt(elements.scheduleDuration.value || 10);
  const total = duration + 1; // +1 minute for transitions
  elements.totalDuration.textContent = `${total}:00`;
}

function addNewSchedule() {
  const selectedDay = elements.daySelector.querySelector('button.active');
  if (!selectedDay || !elements.scheduleTime.value) {
    alert('נא לבחור יום ושעה');
    return;
  }

  const dayIndex = parseInt(selectedDay.dataset.day);
  const newSchedule = {
    start: elements.scheduleTime.value,
    duration: parseInt(elements.scheduleDuration.value || 10)
  };

  // Check if we're editing an existing schedule
  if (elements.scheduleModal.editContext) {
    const { dayIndex: editDayIndex, scheduleIndex } = elements.scheduleModal.editContext;
    appState.scheduleData.week[editDayIndex][scheduleIndex] = newSchedule;
    addActivity('✏️', `עודכנה השקה: ${DAYS[dayIndex]} ${newSchedule.start}`);
    delete elements.scheduleModal.editContext;
  } else {
    // Adding new schedule
    appState.scheduleData.week[dayIndex].push(newSchedule);
    addActivity('➕', `נוספה השקה חדשה: ${DAYS[dayIndex]} ${newSchedule.start}`);
  }

  appState.scheduleData.week[dayIndex].sort((a, b) => a.start.localeCompare(b.start));

  renderScheduleTable();
  saveSchedule();
  closeScheduleModal();
}

// Global functions for inline handlers
window.editSchedule = function(dayIndex, scheduleIndex) {
  const schedule = appState.scheduleData.week[dayIndex][scheduleIndex];
  elements.scheduleTime.value = schedule.start;
  elements.scheduleDuration.value = parseInt(schedule.duration || 10);

  // Mark the day as selected
  elements.daySelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
  elements.daySelector.querySelector(`[data-day="${dayIndex}"]`).classList.add('active');

  updateTotalDuration();
  openScheduleModal();

  // Store edit context
  elements.scheduleModal.editContext = { dayIndex, scheduleIndex };
};

window.deleteSchedule = function(dayIndex, scheduleIndex) {
  if (confirm('האם למחוק השקה זו?')) {
    const schedule = appState.scheduleData.week[dayIndex][scheduleIndex];
    appState.scheduleData.week[dayIndex].splice(scheduleIndex, 1);
    renderScheduleTable();
    saveSchedule();
    addActivity('🗑️', `נמחקה השקה: ${DAYS[dayIndex]} ${schedule.start}`);
  }
};

// Status Updates
async function refreshStatus() {
  // Skip HTTP API calls when in MQTT mode
  if (appState.mqttEnabled) {
    return;
  }

  try {
    const status = await api('/api/status');
    // Update based on server status if needed
  } catch (error) {
    console.error('Failed to refresh status:', error);
  }
}

// Clock Sync
async function syncTime() {
  try {
    await api('/api/time', {
      method: 'POST',
      body: JSON.stringify({ epoch: Math.floor(Date.now() / 1000) })
    });
    addActivity('🔄', 'שעון סונכרן בהצלחה');
  } catch (error) {
    addActivity('❌', 'שגיאה בסנכרון שעון');
  }
}

// Weather & AI Recommendations
async function refreshWeather() {
  // Skip in MQTT mode - wait for weather data from ESP32
  if (appState.mqttEnabled) {
    console.log('Weather: waiting for MQTT data from ESP32');
    return;
  }

  try {
    const weather = await api('/api/weather');
    if (!weather.error) {
      const aiRecommendation = document.getElementById('aiRecommendation');
      const weeklyForecast = document.getElementById('weeklyForecast');

      if (aiRecommendation) {
        aiRecommendation.innerHTML = `<strong>💡 המלצת מערכת AI:</strong> ${weather.recommendation}`;
      }

      // Display 7-day forecast (all days in same style)
      if (weeklyForecast && weather.daily) {
        const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        const today = new Date().getDay();

        weeklyForecast.innerHTML = weather.daily.map((day, index) => {
          const dayName = index === 0 ? 'היום' : dayNames[(today + index) % 7];
          const isToday = index === 0;
          return `
            <div style="text-align: center; padding: 12px; background: ${isToday ? 'var(--accent)' : 'var(--card-bg)'}; border-radius: 8px; ${isToday ? 'border: 2px solid var(--primary);' : ''}">
              <div style="font-size: 13px; font-weight: ${isToday ? 'bold' : 'normal'}; color: var(--muted); margin-bottom: 6px;">${dayName}</div>
              <div style="font-size: 32px; margin: 8px 0;">${day.icon}</div>
              <div style="font-size: 16px; font-weight: bold;">${Math.round(day.temp_max)}°</div>
              <div style="font-size: 13px; color: var(--muted);">${Math.round(day.temp_min)}°</div>
              ${day.precipitation > 0.1 ? `<div style="font-size: 11px; color: #4A90E2; margin-top: 6px;">💧 ${day.precipitation.toFixed(1)}mm</div>` : ''}
            </div>
          `;
        }).join('');
      }
    }
  } catch (error) {
    console.error('Failed to refresh weather:', error);
  }
}

// Event Listeners
function setupEventListeners() {
  // Time updates
  setInterval(() => {
    const now = new Date();
    if (elements.currentTime) {
      elements.currentTime.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
    }
    updateValveDisplay(); // Update system time
  }, 1000);

  // Valve toggle control
  if (elements.valveToggle) {
    elements.valveToggle.addEventListener('click', window.toggleValve);
  }

  // Schedule modal
  if (elements.addScheduleBtn) {
    elements.addScheduleBtn.addEventListener('click', openScheduleModal);
  }
  if (elements.modalClose) {
    elements.modalClose.addEventListener('click', closeScheduleModal);
  }
  if (elements.modalCancel) {
    elements.modalCancel.addEventListener('click', closeScheduleModal);
  }
  if (elements.modalSave) {
    elements.modalSave.addEventListener('click', addNewSchedule);
  }

  // Day selector
  if (elements.daySelector) {
    elements.daySelector.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        elements.daySelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
      }
    });
  }

  // Duration input
  if (elements.scheduleDuration) {
    elements.scheduleDuration.addEventListener('input', updateTotalDuration);
  }

  // Modal click outside
  if (elements.scheduleModal) {
    elements.scheduleModal.addEventListener('click', (e) => {
      if (e.target === elements.scheduleModal) {
        closeScheduleModal();
      }
    });
  }

  // Chat bot functionality
  if (elements.chatBubble) {
    elements.chatBubble.addEventListener('click', openChatWindow);
  }

  if (elements.chatClose) {
    elements.chatClose.addEventListener('click', closeChatWindow);
  }

  if (elements.chatSend) {
    elements.chatSend.addEventListener('click', handleChatSend);
  }

  if (elements.chatInput) {
    elements.chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleChatSend();
      }
    });

    // Enable/disable send button based on input
    elements.chatInput.addEventListener('input', () => {
      const hasText = elements.chatInput.value.trim().length > 0;
      if (elements.chatSend) {
        elements.chatSend.disabled = !hasText;
        elements.chatSend.style.opacity = hasText ? '1' : '0.5';
        elements.chatSend.style.cursor = hasText ? 'pointer' : 'not-allowed';
      }
    });

    // Focus handling
    elements.chatInput.addEventListener('focus', () => {
      elements.chatInput.style.borderColor = 'var(--accent)';
    });

    elements.chatInput.addEventListener('blur', () => {
      elements.chatInput.style.borderColor = 'var(--border)';
    });
  }

  // Chat window click outside to close
  if (elements.chatWindow) {
    elements.chatWindow.addEventListener('click', (e) => {
      if (e.target === elements.chatWindow) {
        closeChatWindow();
      }
    });
  }
}

// Initialize App
async function initApp() {

  setupEventListeners();
  updateValveDisplay();

  // Load initial data
  await loadSchedule();
  await refreshStatus();

  // Start periodic updates
  setInterval(refreshStatus, 5000);

  // Check schedules immediately and then every minute
  checkSchedules();
  setInterval(checkSchedules, 60000);

  // Add welcome activity
  addActivity('🚀', 'מערכת השקיה חכמה הופעלה');

}

function checkSchedules() {
  const now = new Date();
  const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
  const currentTime = now.getHours().toString().padStart(2, '0') + ':' +
                     now.getMinutes().toString().padStart(2, '0');


  if (appState.scheduleData && appState.scheduleData.week) {
    const todaySchedules = appState.scheduleData.week[currentDay];

    if (todaySchedules && todaySchedules.length > 0) {
      todaySchedules.forEach(item => {
        if (item.start === currentTime) {
          // Check if valve is not busy and not in manual operation
          if (appState.valveState === 'closed' && !appState.isManualOperation) {
            addActivity('📅', `השקיה מתוזמנת: ${item.duration} דקות`);
            quickIrrigation(item.duration);
          } else {
            addActivity('⚠️', `השקיה מתוזמנת דולגה - ברז תפוס או במצב ידני`);
          }
        }
      });
    } else {
    }
  } else {
  }
}




function addMessage(content, isUser = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${isUser ? 'user' : 'bot'}`;

  const time = new Date().toLocaleTimeString('he-IL', {
    hour: '2-digit',
    minute: '2-digit'
  });

  messageDiv.innerHTML = `
    ${!isUser ? `<div class="message-avatar bot">🤖</div>` : ''}
    <div class="message-content">
      ${content}
      <div class="message-time">${time}</div>
    </div>
    ${isUser ? `<div class="message-avatar user">👤</div>` : ''}
  `;

  // Remove welcome message if this is the first real message
  const welcome = chatElements.body.querySelector('.chat-welcome');
  if (welcome && (isUser || chatState.conversation.length > 0)) {
    welcome.remove();
  }

  chatElements.body.appendChild(messageDiv);
  scrollChatToBottom();
}

async function sendMessage() {
  const message = chatElements.input.value.trim();
  if (!message || chatState.isProcessing) return;

  chatState.isProcessing = true;
  chatElements.send.disabled = true;
  chatElements.input.disabled = true;

  // Add user message
  addMessage(message, true);
  chatElements.input.value = '';

  // Show typing indicator
  showTyping();

  try {
    // Send to Claude API
    const response = await callClaudeAPI(message);
    hideTyping();

    // Parse response and execute actions
    const parsed = parseClaudeResponse(response);

    if (parsed.needsScheduling) {
      // Add schedule and show confirmation
      await addScheduleFromBot(parsed.schedule);
      addMessage(parsed.response + "\n\n✅ השקיה נוספה בהצלחה ללוח הזמנים!");
      // Refresh schedule display
      await loadSchedule();
    } else {
      // Just show the response
      addMessage(parsed.response);
    }

  } catch (error) {
    hideTyping();
    console.error('Chat error:', error);
    addMessage('מצטער, אירעה שגיאה. אנא נסה שוב מאוחר יותר.');
  }

  chatState.isProcessing = false;
  chatElements.input.disabled = false;
  chatElements.input.focus();
}

async function callClaudeAPI(userMessage) {
  // Local AI bot - processes Hebrew irrigation requests
  return processLocalAI(userMessage);
}

function processLocalAI(message) {
  const msg = message.toLowerCase().trim();

  // Simple pattern matching for Hebrew irrigation requests
  const patterns = {
    // Tomorrow patterns
    tomorrow: /מחר|מחרתיים/,
    // Day patterns
    sunday: /ראשון|יום א/,
    monday: /שני|יום ב/,
    tuesday: /שלישי|יום ג/,
    wednesday: /רביעי|יום ד/,
    thursday: /חמישי|יום ה/,
    friday: /שישי|יום ו/,
    saturday: /שבת|יום ש/,
    // Time patterns
    time: /(\d{1,2}):?(\d{0,2})?\s*(בבוקר|בערב|אחר הצהריים|בלילה)?/,
    // Duration patterns
    duration: /(\d+)\s*(דקות?|דקה)/,
    // Action patterns
    irrigate: /השק|השקה|השקיה|תשקה|תשק/,
    add: /תוסיף|הוסף|צריך|רוצה|אני רוצה/
  };

  // Check if this is an irrigation request
  if (!patterns.irrigate.test(msg) && !patterns.add.test(msg)) {
    return JSON.stringify({
      needsScheduling: false,
      response: "שלום! אני בוט השקיה החכם. אני יכול לעזור לך להוסיף השקיות ללוח הזמנים. נסה לומר משהו כמו: 'השק לי מחר ב-7 בבוקר' או 'תוסיף השקיה לכל יום שני'"
    });
  }

  // Extract day
  let day = null;
  let dayName = '';

  if (patterns.tomorrow.test(msg)) {
    const today = new Date().getDay();
    day = (today + 1) % 7;
    dayName = 'מחר';
  } else if (patterns.sunday.test(msg)) {
    day = 0; dayName = 'יום ראשון';
  } else if (patterns.monday.test(msg)) {
    day = 1; dayName = 'יום שני';
  } else if (patterns.tuesday.test(msg)) {
    day = 2; dayName = 'יום שלישי';
  } else if (patterns.wednesday.test(msg)) {
    day = 3; dayName = 'יום רביעי';
  } else if (patterns.thursday.test(msg)) {
    day = 4; dayName = 'יום חמישי';
  } else if (patterns.friday.test(msg)) {
    day = 5; dayName = 'יום שישי';
  } else if (patterns.saturday.test(msg)) {
    day = 6; dayName = 'שבת';
  }

  // Extract time
  let time = '07:00';
  const timeMatch = msg.match(patterns.time);
  if (timeMatch) {
    let hour = parseInt(timeMatch[1]);
    let minute = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
    const period = timeMatch[3];

    // Adjust for period
    if (period) {
      if (period.includes('בערב') || period.includes('אחר הצהריים')) {
        if (hour < 12) hour += 12;
      } else if (period.includes('בלילה')) {
        if (hour < 6) hour += 12;
      }
    }

    // Validate hour and minute
    if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
      time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
    }
  }

  // Extract duration
  let duration = 10;
  const durationMatch = msg.match(patterns.duration);
  if (durationMatch) {
    const d = parseInt(durationMatch[1]);
    if (d > 0 && d <= 120) {
      duration = d;
    }
  }

  // Build response
  if (day !== null) {
    const totalTime = duration + 1; // +1 for valve transitions
    return JSON.stringify({
      needsScheduling: true,
      response: `מעולה! אני מוסיף השקיה ל${dayName} בשעה ${time} למשך ${duration} דקות (${totalTime} דקות כולל פתיחה וסגירה).`,
      schedule: {
        day: day,
        time: time,
        duration: duration,
        recurring: false
      }
    });
  } else {
    return JSON.stringify({
      needsScheduling: false,
      response: "הבנתי שאתה רוצה השקיה, אבל לא הבנתי איזה יום. אתה יכול לציין יום ספציפי? למשל: 'השק לי מחר ב-7 בבוקר' או 'תוסיף השקיה ליום שני'"
    });
  }
}

function parseClaudeResponse(responseText) {
  try {
    // Try to extract JSON from response
    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new Error('No JSON found in response');
    }

    const parsed = JSON.parse(jsonMatch[0]);

    // Validate response structure
    if (typeof parsed.needsScheduling !== 'boolean' || !parsed.response) {
      throw new Error('Invalid response structure');
    }

    return parsed;
  } catch (error) {
    console.error('Failed to parse Claude response:', error);
    // Fallback response
    return {
      needsScheduling: false,
      response: 'מצטער, לא הבנתי את הבקשה. אתה יכול לנסות לשאול אחרת? למשל: "השק לי מחר ב-7 בבוקר"'
    };
  }
}

async function addScheduleFromBot(schedule) {
  if (!schedule || typeof schedule.day === 'undefined' || !schedule.time) {
    throw new Error('Invalid schedule data');
  }

  // Calculate the day - if it's "tomorrow", calculate based on today
  let targetDay = schedule.day;
  if (schedule.day === 'tomorrow') {
    const today = new Date().getDay();
    targetDay = (today + 1) % 7;
  }

  // Create schedule entry
  const newSchedule = {
    start: schedule.time || '07:00',
    duration: schedule.duration || 10
  };

  // Add to the schedule data
  if (!appState.scheduleData.week[targetDay]) {
    appState.scheduleData.week[targetDay] = [];
  }

  appState.scheduleData.week[targetDay].push(newSchedule);

  // Sort by time
  appState.scheduleData.week[targetDay].sort((a, b) => a.start.localeCompare(b.start));

  // Save to server
  await saveSchedule();

  // Add activity log
  const dayName = DAYS[targetDay];
  addActivity('🤖', `בוט הוסיף השקיה: ${dayName} ${newSchedule.start}`);
}

// ========== MQTT Support ==========
// MQTT Configuration - HiveMQ Cloud
const MQTT_CONFIG = {
  broker: 'wss://29a89a40f1334d2f9a53bd7a92ca2280.s1.eu.hivemq.cloud:8884/mqtt',
  username: 'esp32_irrigation',
  password: 'Alonmalka33',
  topics: {
    command: 'irrigation/command',
    status: 'irrigation/status',
    sensors: 'irrigation/sensors',
    schedule: 'irrigation/schedule',
    weather: 'irrigation/weather',
    request: 'irrigation/request'
  }
};

function initMqtt() {
  // Check if we're on local network (192.168.x.x or localhost)
  const isLocal = window.FORCE_REMOTE_MODE ? false : window.location.hostname.match(/^(192\.168\.|10\.|localhost)/);
  appState.localMode = isLocal;

  // Only connect to MQTT if not on local network
  if (isLocal) {
    console.log('MQTT disabled - using local HTTP API');
    return;
  }

  console.log('Initializing MQTT connection...');

  // Load MQTT.js library dynamically
  const script = document.createElement('script');
  script.src = 'https://unpkg.com/mqtt/dist/mqtt.min.js';
  script.onload = function() {
    try {
      appState.mqttClient = mqtt.connect(MQTT_CONFIG.broker, {
        username: MQTT_CONFIG.username,
        password: MQTT_CONFIG.password,
        clientId: 'web_' + Math.random().toString(16).substr(2, 8),
        reconnectPeriod: 5000
      });

      appState.mqttClient.on('connect', function() {
        console.log('MQTT connected!');
        appState.mqttEnabled = true;
        addActivity('🌐', 'מחובר למצב מרוחק (MQTT)');

        // Subscribe to topics
        appState.mqttClient.subscribe(MQTT_CONFIG.topics.status);
        appState.mqttClient.subscribe(MQTT_CONFIG.topics.sensors);
        appState.mqttClient.subscribe(MQTT_CONFIG.topics.schedule);

        // Subscribe to weather and request data after subscription completes
        appState.mqttClient.subscribe(MQTT_CONFIG.topics.weather, function(err) {
          if (!err) {
            // Now request weather data after we're subscribed
            setTimeout(function() {
              appState.mqttClient.publish(MQTT_CONFIG.topics.request, 'weather');
              console.log('Requested weather data from ESP32');
            }, 100);
          }
        });
      });

      appState.mqttClient.on('message', function(topic, message) {
        try {
          const data = JSON.parse(message.toString());
          console.log('MQTT message:', topic, data);

          if (topic === MQTT_CONFIG.topics.sensors) {
            // Update valve state from sensor data
            if (data.valveState !== undefined) {
              const stateMap = {0: 'closed', 1: 'opening', 2: 'open', 3: 'closing'};
              appState.valveState = stateMap[data.valveState] || 'closed';
              updateValveDisplay();
            }
          }

          else if (topic === MQTT_CONFIG.topics.status) {
            console.log('Status update:', data);
          }

          else if (topic === MQTT_CONFIG.topics.schedule) {
            // Schedule sync from another device
            console.log('Schedule sync received:', data);
            appState.scheduleData = data;
            renderScheduleTable();
            addActivity('🔄', 'לוח זמנים סונכרן ממכשיר אחר');
          }

          else if (topic === MQTT_CONFIG.topics.weather) {
            // Weather data sync
            console.log('Weather sync received:', data);
            if (data && !data.error) {
              const aiRecommendation = document.getElementById('aiRecommendation');
              const weeklyForecast = document.getElementById('weeklyForecast');

              if (aiRecommendation) {
                aiRecommendation.innerHTML = `<strong>💡 המלצת מערכת AI:</strong> ${data.recommendation}`;
              }

              if (weeklyForecast && data.daily) {
                const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
                const today = new Date().getDay();

                weeklyForecast.innerHTML = data.daily.map((day, index) => {
                  const dayName = index === 0 ? 'היום' : dayNames[(today + index) % 7];
                  const isToday = index === 0;
                  return `
                    <div style="text-align: center; padding: 12px; background: ${isToday ? 'var(--accent)' : 'var(--card-bg)'}; border-radius: 8px;">
                      <div style="font-size: 13px; font-weight: ${isToday ? 'bold' : 'normal'}; color: var(--muted); margin-bottom: 6px;">${dayName}</div>
                      <div style="font-size: 32px; margin: 8px 0;">${day.icon}</div>
                      <div style="font-size: 16px; font-weight: bold;">${Math.round(day.temp_max)}°</div>
                      <div style="font-size: 13px; color: var(--muted);">${Math.round(day.temp_min)}°</div>
                      ${day.precipitation > 0.1 ? `<div style="font-size: 11px; color: #4A90E2; margin-top: 6px;">💧 ${day.precipitation.toFixed(1)}mm</div>` : ''}
                    </div>
                  `;
                }).join('');
              }
            }
          }
        } catch (e) {
          console.error('Error parsing MQTT message:', e);
        }
      });

      appState.mqttClient.on('error', function(error) {
        console.error('MQTT error:', error);
        appState.mqttEnabled = false;
      });

      appState.mqttClient.on('close', function() {
        console.log('MQTT disconnected');
        appState.mqttEnabled = false;
      });

    } catch (error) {
      console.error('Failed to initialize MQTT:', error);
    }
  };
  document.head.appendChild(script);
}

// Modified valve control to support both HTTP and MQTT
async function sendValveCommand(action) {
  if (appState.mqttEnabled && appState.mqttClient && appState.mqttClient.connected) {
    // Use MQTT
    const command = { action: action };
    appState.mqttClient.publish(
      MQTT_CONFIG.topics.command,
      JSON.stringify(command)
    );
    console.log('Sent MQTT command:', command);
    addActivity('📡', `פקודה נשלחה דרך MQTT: ${action}`);
  } else {
    // Use HTTP API (local mode)
    await api('/api/zone?cmd=' + action, { method: 'POST' });
  }
}

// Start the app when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  initApp();

  // Initialize MQTT if available
  initMqtt();

  // Load weather data
  refreshWeather();

  // Refresh weather every 30 minutes
  setInterval(refreshWeather, 30 * 60 * 1000);
});
</script>
</body></html>
